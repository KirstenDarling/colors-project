{"version":3,"file":"GeopointInput.js","names":["getStaticImageUrl","value","loc","lat","lng","params","key","config","apiKey","center","markers","zoom","scale","size","qs","Object","keys","reduce","res","param","concat","encodeURIComponent","join","GeopointInput","React","PureComponent","constructor","props","uniqueId","el","editButton","event","onFocus","onBlur","setState","prevState","modalOpen","state","latLng","type","onChange","PatchEvent","from","setIfMissing","_type","name","set","unset","focus","render","compareValue","readOnly","level","presence","whiteSpace","title","description","handleFocus","handleBlur","EditIcon","setEditButton","handleToggleModal","TrashIcon","handleClear","_geopointInputId","handleCloseModal","api","undefined","handleChange","defaultLocation","defaultZoom"],"sources":["../../src/input/GeopointInput.tsx"],"sourcesContent":["// @todo: remove the following line when part imports has been removed from this file\n///<reference types=\"@sanity/types/parts\" />\n\nimport React from 'react'\nimport {uniqueId} from 'lodash'\nimport {Box, Grid, Button, Dialog} from '@sanity/ui'\nimport {TrashIcon, EditIcon} from '@sanity/icons'\nimport {Path, Marker} from '@sanity/types'\nimport config from 'config:@sanity/google-maps-input'\nimport {FormFieldSet} from '@sanity/base/components'\nimport {FormFieldPresence} from '@sanity/base/presence'\nimport {PatchEvent, set, setIfMissing, unset} from 'part:@sanity/form-builder/patch-event'\nimport {ChangeIndicatorCompareValueProvider, ChangeIndicator} from '@sanity/base/change-indicators'\nimport {GoogleMapsLoadProxy} from '../loader/GoogleMapsLoadProxy'\nimport {Geopoint, GeopointSchemaType} from '../types'\nimport {GeopointSelect} from './GeopointSelect'\nimport {PreviewImage, DialogInnerContainer} from './GeopointInput.styles'\n\nconst getStaticImageUrl = (value) => {\n  const loc = `${value.lat},${value.lng}`\n  const params = {\n    key: config.apiKey,\n    center: loc,\n    markers: loc,\n    zoom: 13,\n    scale: 2,\n    size: '640x300',\n  }\n\n  const qs = Object.keys(params).reduce((res, param) => {\n    return res.concat(`${param}=${encodeURIComponent(params[param])}`)\n  }, [] as string[])\n\n  return `https://maps.googleapis.com/maps/api/staticmap?${qs.join('&')}`\n}\n\ninterface InputProps {\n  markers: Marker[]\n  level?: number\n  value?: Geopoint\n  compareValue?: Geopoint\n  type: GeopointSchemaType\n  readOnly?: boolean\n  onFocus: (path: Path) => void\n  onBlur: () => void\n  onChange: (patchEvent: unknown) => void\n  presence: FormFieldPresence[]\n}\n\n// @todo\n// interface Focusable {\n//   focus: () => void\n// }\ntype Focusable = any\n\ninterface InputState {\n  modalOpen: boolean\n}\n\nclass GeopointInput extends React.PureComponent<InputProps, InputState> {\n  _geopointInputId = uniqueId('GeopointInput')\n\n  static defaultProps = {\n    markers: [],\n  }\n\n  editButton: Focusable | undefined\n\n  constructor(props) {\n    super(props)\n\n    this.state = {\n      modalOpen: false,\n    }\n  }\n\n  setEditButton = (el: Focusable) => {\n    this.editButton = el\n  }\n\n  focus() {\n    if (this.editButton) {\n      this.editButton.focus()\n    }\n  }\n\n  handleFocus = (event) => {\n    this.props.onFocus(event)\n  }\n\n  handleBlur = () => {\n    this.props.onBlur()\n  }\n\n  handleToggleModal = () => {\n    const {onFocus, onBlur} = this.props\n    this.setState(\n      (prevState) => ({modalOpen: !prevState.modalOpen}),\n      () => {\n        if (this.state.modalOpen) {\n          onFocus(['$'])\n        } else {\n          onBlur()\n        }\n      }\n    )\n  }\n\n  handleCloseModal = () => {\n    this.setState({modalOpen: false})\n  }\n\n  handleChange = (latLng: google.maps.LatLng) => {\n    const {type, onChange} = this.props\n    onChange(\n      PatchEvent.from([\n        setIfMissing({\n          _type: type.name,\n        }),\n        set(latLng.lat(), ['lat']),\n        set(latLng.lng(), ['lng']),\n      ])\n    )\n  }\n\n  handleClear = () => {\n    const {onChange} = this.props\n    onChange(PatchEvent.from(unset()))\n  }\n\n  render() {\n    const {value, compareValue, readOnly, type, markers, level, presence} = this.props\n    const {modalOpen} = this.state\n\n    if (!config || !config.apiKey) {\n      return (\n        <div>\n          <p>\n            The <a href=\"https://sanity.io/docs/schema-types/geopoint-type\">Geopoint type</a> needs\n            a Google Maps API key with access to:\n          </p>\n          <ul>\n            <li>Google Maps JavaScript API</li>\n            <li>Google Places API Web Service</li>\n            <li>Google Static Maps API</li>\n          </ul>\n          <p>\n            Please enter the API key with access to these services in\n            <code style={{whiteSpace: 'nowrap'}}>\n              `&lt;project-root&gt;/config/@sanity/google-maps-input.json`\n            </code>\n          </p>\n        </div>\n      )\n    }\n\n    return (\n      <FormFieldSet\n        level={level}\n        title={type.title}\n        description={type.description}\n        onFocus={this.handleFocus}\n        onBlur={this.handleBlur}\n        __unstable_presence={presence}\n        __unstable_changeIndicator={false}\n        __unstable_markers={markers}\n      >\n        <div>\n          {value && (\n            <ChangeIndicatorCompareValueProvider value={value} compareValue={compareValue}>\n              <ChangeIndicator compareDeep>\n                <PreviewImage src={getStaticImageUrl(value)} alt=\"Map location\" />\n              </ChangeIndicator>\n            </ChangeIndicatorCompareValueProvider>\n          )}\n\n          {!readOnly && (\n            <Box marginTop={4}>\n              <Grid columns={2} gap={2}>\n                <Button\n                  mode=\"ghost\"\n                  icon={value && EditIcon}\n                  padding={3}\n                  ref={this.setEditButton}\n                  text={value ? 'Edit' : 'Set location'}\n                  onClick={this.handleToggleModal}\n                />\n\n                {value && (\n                  <Button\n                    tone=\"critical\"\n                    icon={TrashIcon}\n                    padding={3}\n                    mode=\"ghost\"\n                    text={'Remove'}\n                    onClick={this.handleClear}\n                  />\n                )}\n              </Grid>\n            </Box>\n          )}\n\n          {modalOpen && (\n            <Dialog\n              id={`${this._geopointInputId}_dialog`}\n              onClose={this.handleCloseModal}\n              header=\"Place the marker on the map\"\n              width={1}\n            >\n              <DialogInnerContainer>\n                <GoogleMapsLoadProxy>\n                  {(api) => (\n                    <GeopointSelect\n                      api={api}\n                      value={value}\n                      onChange={readOnly ? undefined : this.handleChange}\n                      defaultLocation={config.defaultLocation}\n                      defaultZoom={config.defaultZoom}\n                    />\n                  )}\n                </GoogleMapsLoadProxy>\n              </DialogInnerContainer>\n            </Dialog>\n          )}\n        </div>\n      </FormFieldSet>\n    )\n  }\n}\n\nexport default GeopointInput\n"],"mappings":"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"}