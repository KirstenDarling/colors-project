"use strict";var e,t,n,o,r;function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function a(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){s(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e,t){return t||(t=e.slice(0)),Object.freeze(Object.defineProperties(e,{raw:{value:Object.freeze(t)}}))}Object.defineProperty(exports,"__esModule",{value:!0});var c=require("react/jsx-runtime"),d=require("react"),p=require("lodash"),h=require("@sanity/ui"),u=require("@sanity/icons"),f=require("sanity"),m=require("styled-components");function g(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}function x(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(n){if("default"!==n){var o=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,o.get?o:{enumerable:!0,get:function(){return e[n]}})}})),t.default=e,Object.freeze(t)}var j=x(d),v=g(d),y=g(m);const C="___sanity_googleMapsApiCallback";class k extends Error{}function b(e){return new Promise(((t,n)=>{window.gm_authFailure=()=>{n(new k("Authentication error when loading Google Maps API."))},window[C]=()=>{t(window.google.maps)};const o=document.createElement("script");o.onerror=(e,t,o,r,i)=>n(new Error(function(e,t){if(t)return t.message;if("string"==typeof e)return e;return function(e){if("object"!=typeof e||null===e)return!1;if(!("message"in e))return!1;return"string"==typeof e.message}(e)?e.message:"Failed to load Google Maps API"}(e,i))),o.src="https://maps.googleapis.com/maps/api/js?key=".concat(e.apiKey,"&libraries=places&callback=").concat(C,"&language=").concat(e.locale),document.getElementsByTagName("head")[0].appendChild(o)})).finally((()=>{delete window[C],delete window.gm_authFailure}))}let w=null;function M(e){var t;return c.jsxs(h.Card,{tone:"critical",radius:1,children:[c.jsx(h.Box,{as:"header",paddingX:4,paddingTop:4,paddingBottom:1,children:c.jsx(h.Text,{as:"h2",weight:"bold",children:"Google Maps failed to load"})}),c.jsx(h.Box,{paddingX:4,paddingTop:4,paddingBottom:1,children:e.isAuthError?c.jsx(P,{}):c.jsxs(c.Fragment,{children:[c.jsx(h.Text,{as:"h3",children:"Error details:"}),c.jsx("pre",{children:c.jsx(h.Code,{size:1,children:"error"in e&&(null==(t=e.error)?void 0:t.message)})})]})})]})}function P(){return c.jsxs(h.Text,{children:[c.jsx("p",{children:"The error appears to be related to authentication"}),c.jsx("p",{children:"Common causes include:"}),c.jsxs("ul",{children:[c.jsx("li",{children:"Incorrect API key"}),c.jsx("li",{children:"Referer not allowed"}),c.jsx("li",{children:"Missing authentication scope"})]}),c.jsx("p",{children:"Check the browser developer tools for more information."})]})}const O="undefined"!=typeof window&&window.navigator.language||"en";function I(e){const t=e.defaultLocale||O||"en-US",[n,o]=d.useState({type:"loading"});return d.useEffect((()=>{(function(e){return w||(w=b(e),w.catch((()=>{w=null})),w)})({locale:t,apiKey:e.apiKey}).then((e=>o({type:"loaded",api:e})),(e=>o({type:"error",error:{type:e instanceof k?"authError":"loadError",message:e.message}})))}),[t,e.apiKey]),n}function E(e){const t=I(e.config);switch(t.type){case"error":return c.jsx(M,{error:t.error,isAuthError:"authError"===t.error.type});case"loading":return c.jsx("div",{children:"Loading Google Maps API"});case"loaded":return e.children(t.api);default:return null}}const H=y.default.div(e||(e=l(["\n  position: absolute;\n  right: 10px;\n  top: 10px;\n  width: 220px;\n"])));class T extends j.PureComponent{constructor(){super(...arguments),this.searchInputRef=j.createRef(),this.handleChange=()=>{this.autoComplete&&(this.props.onChange(this.autoComplete.getPlace()),this.searchInputRef.current&&(this.searchInputRef.current.value=""))}}componentDidMount(){const e=this.searchInputRef.current;if(!e)return;const{api:t,map:n}=this.props,{Circle:o,places:r,event:i}=t,a=new o({center:n.getCenter(),radius:100}).getBounds();this.autoComplete=new r.Autocomplete(e,{bounds:a,types:[]}),i.addListener(this.autoComplete,"place_changed",this.handleChange)}render(){return c.jsx(H,{children:c.jsx(h.TextInput,{name:"place",ref:this.searchInputRef,placeholder:"Search for place or address",padding:4})})}}function A(e,t){const n="function"==typeof e.lat?e.lat():e.lat,o="function"==typeof e.lng?e.lng():e.lng,r="function"==typeof t.lat?t.lat():t.lat,i="function"==typeof t.lng?t.lng():t.lng;return n===r&&o===i}const R=y.default.div(t||(t=l(["\n  position: absolute;\n  top: 0;\n  left: 0;\n  height: 100%;\n  width: 100%;\n  box-sizing: border-box;\n"])));class L extends v.default.PureComponent{constructor(){super(...arguments),this.state={map:void 0},this.mapRef=v.default.createRef(),this.mapEl=null,this.attachClickHandler=()=>{const e=this.state.map;if(!e)return;const{api:t,onClick:n}=this.props,{event:o}=t;this.clickHandler&&this.clickHandler.remove(),n&&(this.clickHandler=o.addListener(e,"click",n))},this.setMapElement=e=>{if(e&&e!==this.mapEl){const t=this.constructMap(e);this.setState({map:t},this.attachClickHandler)}this.mapEl=e}}componentDidMount(){this.attachClickHandler()}componentDidUpdate(e){const t=this.state.map;if(!t)return;const{onClick:n,location:o,bounds:r}=this.props;e.onClick!==n&&this.attachClickHandler(),A(e.location,o)||t.panTo(this.getCenter()),!r||e.bounds&&r.equals(e.bounds)||t.fitBounds(r)}componentWillUnmount(){this.clickHandler&&this.clickHandler.remove()}getCenter(){const{location:e,api:t}=this.props;return new t.LatLng(e.lat,e.lng)}constructMap(e){const{defaultZoom:t,api:n,mapTypeControl:o,controlSize:r,bounds:i,scrollWheel:a}=this.props,s=new n.Map(e,{zoom:t,center:this.getCenter(),scrollwheel:a,streetViewControl:!1,mapTypeControl:o,controlSize:r});return i&&s.fitBounds(i),s}render(){const{children:e}=this.props,{map:t}=this.state;return c.jsxs(c.Fragment,{children:[c.jsx(R,{ref:this.setMapElement}),e&&t?e(t):null]})}}L.defaultProps={defaultZoom:8,scrollWheel:!0};class z extends j.PureComponent{constructor(){super(...arguments),this.eventHandlers={}}componentDidMount(){const{position:e,api:t,map:n,onMove:o,zIndex:r,opacity:i,label:a,markerRef:s,color:l}=this.props,{Marker:c}=t;let d;l&&(d={path:"M 3.052 3.7 C 1.56 5.293 0.626 7.612 0.663 9.793 C 0.738 14.352 2.793 16.077 6.078 22.351 C 7.263 25.111 8.497 28.032 9.672 32.871 C 9.835 33.584 9.994 34.246 10.069 34.305 C 10.143 34.362 10.301 33.697 10.465 32.983 C 11.639 28.145 12.875 25.226 14.059 22.466 C 17.344 16.192 19.398 14.466 19.474 9.908 C 19.511 7.727 18.574 5.405 17.083 3.814 C 15.379 1.994 12.809 0.649 10.069 0.593 C 7.328 0.536 4.756 1.882 3.052 3.7 Z",fillOpacity:1,fillColor:l.background,strokeColor:l.border,strokeWeight:2,anchor:new t.Point(10,35),labelOrigin:new t.Point(10,11)}),this.marker=new c({draggable:Boolean(o),position:e,map:n,zIndex:r,opacity:i,label:a,icon:d}),s&&(s.current=this.marker),this.attachMoveHandler(),this.attachClickHandler()}componentDidUpdate(e){if(!this.marker)return;const{position:t,onMove:n,label:o,zIndex:r,opacity:i,map:a}=this.props;e.onMove!==n&&this.attachMoveHandler(),A(e.position,t)||this.marker.setPosition(t),e.label!==o&&this.marker.setLabel(o||null),e.zIndex!==r&&this.marker.setZIndex(r||null),e.opacity!==i&&this.marker.setOpacity(i||null),e.map!==a&&this.marker.setMap(a)}componentWillUnmount(){this.eventHandlers.move&&this.eventHandlers.move.remove(),this.marker&&this.marker.setMap(null)}attachMoveHandler(){const{api:e,onMove:t}=this.props;this.eventHandlers.move&&this.eventHandlers.move.remove(),this.marker&&t&&(this.eventHandlers.move=e.event.addListener(this.marker,"dragend",t))}attachClickHandler(){const{api:e,onClick:t}=this.props;this.eventHandlers.click&&this.eventHandlers.click.remove(),this.marker&&t&&(this.eventHandlers.click=e.event.addListener(this.marker,"click",t))}render(){return null}}const D={lat:40.7058254,lng:-74.1180863};class B extends v.default.PureComponent{constructor(){super(...arguments),this.mapRef=v.default.createRef(),this.handlePlaceChanged=e=>{var t;(null==(t=e.geometry)?void 0:t.location)&&this.setValue(e.geometry.location)},this.handleMarkerDragEnd=e=>{e.latLng&&this.setValue(e.latLng)},this.handleMapClick=e=>{e.latLng&&this.setValue(e.latLng)}}getCenter(){const{value:e={},defaultLocation:t={}}=this.props;return a(a(a({},D),t),e)}setValue(e){this.props.onChange&&this.props.onChange(e)}render(){const{api:e,defaultZoom:t,value:n,onChange:o}=this.props;return c.jsx(L,{api:e,location:this.getCenter(),onClick:this.handleMapClick,defaultZoom:t,children:t=>c.jsxs(c.Fragment,{children:[c.jsx(T,{api:e,map:t,onChange:this.handlePlaceChanged}),n&&c.jsx(z,{api:e,map:t,position:n,onMove:o?this.handleMarkerDragEnd:void 0})]})})}}B.defaultProps={defaultZoom:8,defaultLocation:{lng:10.74609,lat:59.91273}};const S=y.default.img(n||(n=l(["\n  width: 100%;\n  height: auto;\n  vertical-align: top;\n"]))),_=y.default.div(o||(o=l(["\n  height: 40rem;\n  width: 50rem;\n"])));let V;function G(){return V}function F(e){V=e}const U=(e,t)=>{const n="".concat(e.lat,",").concat(e.lng),o={key:t,center:n,markers:n,zoom:13,scale:2,size:"640x300"},r=Object.keys(o).reduce(((e,t)=>e.concat("".concat(t,"=").concat(encodeURIComponent(o[t])))),[]);return"https://maps.googleapis.com/maps/api/staticmap?".concat(r.join("&"))};class W extends v.default.PureComponent{constructor(e){super(e),this._geopointInputId=p.uniqueId("GeopointInput"),this.setEditButton=e=>{this.editButton=e},this.handleToggleModal=()=>{this.setState((e=>({modalOpen:!e.modalOpen})))},this.handleCloseModal=()=>{this.setState({modalOpen:!1})},this.handleChange=e=>{const{schemaType:t,onChange:n}=this.props;n([f.setIfMissing({_type:t.name}),f.set(e.lat(),["lat"]),f.set(e.lng(),["lng"])])},this.handleClear=()=>{const{onChange:e}=this.props;e(f.unset())},this.state={modalOpen:!1}}focus(){this.editButton&&this.editButton.focus()}render(){const{value:e,readOnly:t,geoConfig:n,path:o,changed:r,focused:i}=this.props,{modalOpen:a}=this.state;return n&&n.apiKey?c.jsxs(c.Fragment,{children:[e&&c.jsx(f.ChangeIndicator,{path:o,isChanged:r,hasFocus:!!i,children:c.jsx(S,{src:U(e,n.apiKey),alt:"Map location"})}),!t&&c.jsx(h.Box,{marginTop:4,children:c.jsxs(h.Grid,{columns:2,gap:2,children:[c.jsx(h.Button,{mode:"ghost",icon:e&&u.EditIcon,padding:3,ref:this.setEditButton,text:e?"Edit":"Set location",onClick:this.handleToggleModal}),e&&c.jsx(h.Button,{tone:"critical",icon:u.TrashIcon,padding:3,mode:"ghost",text:"Remove",onClick:this.handleClear})]})}),a&&c.jsx(h.Dialog,{id:"".concat(this._geopointInputId,"_dialog"),onClose:this.handleCloseModal,header:"Place the marker on the map",width:1,children:c.jsx(_,{children:c.jsx(E,{config:G(),children:o=>c.jsx(B,{api:o,value:e||void 0,onChange:t?void 0:this.handleChange,defaultLocation:n.defaultLocation,defaultZoom:n.defaultZoom})})})})]}):c.jsxs("div",{children:[c.jsxs("p",{children:["The ",c.jsx("a",{href:"https://sanity.io/docs/schema-types/geopoint-type",children:"Geopoint type"})," needs a Google Maps API key with access to:"]}),c.jsxs("ul",{children:[c.jsx("li",{children:"Google Maps JavaScript API"}),c.jsx("li",{children:"Google Places API Web Service"}),c.jsx("li",{children:"Google Static Maps API"})]}),c.jsx("p",{children:"Please enter the API key with access to these services in your googleMapsInput plugin config."})]})}}class q extends j.PureComponent{constructor(){super(...arguments),this.eventHandlers={}}componentDidMount(){const{from:e,to:t,api:n,map:o,zIndex:r,onClick:i,color:a,arrowRef:s}=this.props,l={path:n.SymbolPath.FORWARD_OPEN_ARROW};this.line=new n.Polyline({map:o,zIndex:r,path:[e,t],icons:[{icon:l,offset:"50%"}],strokeOpacity:.55,strokeColor:a?a.text:"black"}),i&&(this.eventHandlers.click=n.event.addListener(this.line,"click",i)),s&&(s.current=this.line)}componentDidUpdate(e){if(!this.line)return;const{from:t,to:n,map:o}=this.props;A(e.from,t)&&A(e.to,n)||this.line.setPath([t,n]),e.map!==o&&this.line.setMap(o)}componentWillUnmount(){this.line&&this.line.setMap(null),this.eventHandlers.click&&this.eventHandlers.click.remove()}render(){return null}}function Z(e){let{diff:t,api:n,map:o,label:r}=e;const{fromValue:i,toValue:a}=t,s=t.isChanged?t.annotation:void 0,l=f.useUserColor(s?s.author:null)||void 0,d=j.useRef(),p=j.useRef();return c.jsxs(c.Fragment,{children:[i&&c.jsx(z,{api:n,map:o,position:i,zIndex:0,opacity:.55,markerRef:d,color:l}),i&&a&&c.jsx(q,{api:n,map:o,from:i,to:a,zIndex:1,color:l}),a&&c.jsx(z,{api:n,map:o,position:a,zIndex:2,markerRef:p,label:r,color:l})]})}const K=y.default.div(r||(r=l(["\n  position: relative;\n  min-height: 200px;\n\n  &:empty {\n    background-color: var(--card-skeleton-color-from);\n    display: table;\n    width: 100%;\n  }\n\n  &:empty:after {\n    content: 'Missing/invalid data';\n    display: table-cell;\n    vertical-align: middle;\n    text-align: center;\n    position: relative;\n  }\n"])));function N(e){let{api:t,diff:n}=e;const o=(n.fromValue||[]).filter(J),r=(n.toValue||[]).filter(J);if(0===o.length&&0===r.length)return null;const i=function(e,t,n){const o=new n.LatLngBounds;return[...e||[],...t||[]].forEach((e=>o.extend(e))),o}(o,r,t);return c.jsx(L,{api:t,location:i.getCenter().toJSON(),mapTypeControl:!1,controlSize:20,bounds:i,children:e=>c.jsx(c.Fragment,{children:n.items.map((n=>{let{toIndex:o,diff:r}=n;return function(e){return"unchanged"!==e.action&&"object"===e.type}(r)?c.jsx(Z,{api:t,map:e,diff:r,label:"".concat(o)},o):null}))})})}function J(e){return"number"==typeof e.lat&&"number"==typeof e.lng}function X(e){let{api:t,diff:n}=e;const{fromValue:o,toValue:r}=n,i=f.getAnnotationAtPath(n,["lat"])||f.getAnnotationAtPath(n,["lng"])||f.getAnnotationAtPath(n,[]),a=function(e,t){const{fromValue:n,toValue:o}=e;if(n&&o)return Q(n,o,t).getCenter().toJSON();if(n)return n;if(o)return o;throw new Error("Neither a from or a to value present")}(n,t),s=o&&r?Q(o,r,t):void 0;return c.jsx(f.DiffTooltip,{annotations:i?[i]:[],description:Y(n),children:c.jsx("div",{children:c.jsx(L,{api:t,location:a,mapTypeControl:!1,controlSize:20,bounds:s,scrollWheel:!1,children:e=>c.jsx(Z,{api:t,map:e,diff:n})})})})}function Q(e,t,n){return(new n.LatLngBounds).extend(e).extend(t)}function Y(e){const{fromValue:t,toValue:n}=e;return t&&n?"Moved":t?"Removed":n?"Added":"Unchanged"}const $=f.definePlugin((e=>(F(e),{name:"google-maps-input",form:{components:{input(t){if(ee("geopoint",t.schemaType)){const n=t;return c.jsx(W,a(a({},n),{},{geoConfig:e}))}return t.renderDefault(t)}}}})));function ee(e,t){return(null==t?void 0:t.name)===e||!!(null==t?void 0:t.name)&&ee(e,null==t?void 0:t.type)}exports.GeopointArrayDiff=e=>{let{diff:t,schemaType:n}=e;return c.jsx(K,{children:c.jsx(E,{config:G(),children:e=>c.jsx(N,{api:e,diff:t,schemaType:n})})})},exports.GeopointFieldDiff=e=>{let{diff:t,schemaType:n}=e;return c.jsx(K,{children:c.jsx(E,{config:G(),children:e=>c.jsx(X,{api:e,diff:t,schemaType:n})})})},exports.GeopointInput=W,exports.googleMapsInput=$;
//# sourceMappingURL=index.js.map
