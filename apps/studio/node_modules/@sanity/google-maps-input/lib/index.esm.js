var e,t,n,o,r;function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function a(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){l(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function s(e,t){return t||(t=e.slice(0)),Object.freeze(Object.defineProperties(e,{raw:{value:Object.freeze(t)}}))}import{jsxs as c,jsx as p,Fragment as d}from"react/jsx-runtime";import*as h from"react";import u,{useState as m,useEffect as f}from"react";import{uniqueId as g}from"lodash";import{Card as v,Box as y,Text as C,Code as k,TextInput as b,Grid as w,Button as M,Dialog as P}from"@sanity/ui";import{EditIcon as O,TrashIcon as x}from"@sanity/icons";import{setIfMissing as I,set as H,unset as E,ChangeIndicator as R,useUserColor as L,getAnnotationAtPath as j,DiffTooltip as z,definePlugin as T}from"sanity";import S from"styled-components";const A="___sanity_googleMapsApiCallback";class D extends Error{}function V(e){return new Promise(((t,n)=>{window.gm_authFailure=()=>{n(new D("Authentication error when loading Google Maps API."))},window[A]=()=>{t(window.google.maps)};const o=document.createElement("script");o.onerror=(e,t,o,r,i)=>n(new Error(function(e,t){if(t)return t.message;if("string"==typeof e)return e;return function(e){if("object"!=typeof e||null===e)return!1;if(!("message"in e))return!1;return"string"==typeof e.message}(e)?e.message:"Failed to load Google Maps API"}(e,i))),o.src="https://maps.googleapis.com/maps/api/js?key=".concat(e.apiKey,"&libraries=places&callback=").concat(A,"&language=").concat(e.locale),document.getElementsByTagName("head")[0].appendChild(o)})).finally((()=>{delete window[A],delete window.gm_authFailure}))}let B=null;function _(e){var t;return c(v,{tone:"critical",radius:1,children:[p(y,{as:"header",paddingX:4,paddingTop:4,paddingBottom:1,children:p(C,{as:"h2",weight:"bold",children:"Google Maps failed to load"})}),p(y,{paddingX:4,paddingTop:4,paddingBottom:1,children:e.isAuthError?p(G,{}):c(d,{children:[p(C,{as:"h3",children:"Error details:"}),p("pre",{children:p(k,{size:1,children:"error"in e&&(null==(t=e.error)?void 0:t.message)})})]})})]})}function G(){return c(C,{children:[p("p",{children:"The error appears to be related to authentication"}),p("p",{children:"Common causes include:"}),c("ul",{children:[p("li",{children:"Incorrect API key"}),p("li",{children:"Referer not allowed"}),p("li",{children:"Missing authentication scope"})]}),p("p",{children:"Check the browser developer tools for more information."})]})}const W="undefined"!=typeof window&&window.navigator.language||"en";function U(e){const t=e.defaultLocale||W||"en-US",[n,o]=m({type:"loading"});return f((()=>{(function(e){return B||(B=V(e),B.catch((()=>{B=null})),B)})({locale:t,apiKey:e.apiKey}).then((e=>o({type:"loaded",api:e})),(e=>o({type:"error",error:{type:e instanceof D?"authError":"loadError",message:e.message}})))}),[t,e.apiKey]),n}function Z(e){const t=U(e.config);switch(t.type){case"error":return p(_,{error:t.error,isAuthError:"authError"===t.error.type});case"loading":return p("div",{children:"Loading Google Maps API"});case"loaded":return e.children(t.api);default:return null}}const K=S.div(e||(e=s(["\n  position: absolute;\n  right: 10px;\n  top: 10px;\n  width: 220px;\n"])));class F extends h.PureComponent{constructor(){super(...arguments),this.searchInputRef=h.createRef(),this.handleChange=()=>{this.autoComplete&&(this.props.onChange(this.autoComplete.getPlace()),this.searchInputRef.current&&(this.searchInputRef.current.value=""))}}componentDidMount(){const e=this.searchInputRef.current;if(!e)return;const{api:t,map:n}=this.props,{Circle:o,places:r,event:i}=t,a=new o({center:n.getCenter(),radius:100}).getBounds();this.autoComplete=new r.Autocomplete(e,{bounds:a,types:[]}),i.addListener(this.autoComplete,"place_changed",this.handleChange)}render(){return p(K,{children:p(b,{name:"place",ref:this.searchInputRef,placeholder:"Search for place or address",padding:4})})}}function N(e,t){const n="function"==typeof e.lat?e.lat():e.lat,o="function"==typeof e.lng?e.lng():e.lng,r="function"==typeof t.lat?t.lat():t.lat,i="function"==typeof t.lng?t.lng():t.lng;return n===r&&o===i}const J=S.div(t||(t=s(["\n  position: absolute;\n  top: 0;\n  left: 0;\n  height: 100%;\n  width: 100%;\n  box-sizing: border-box;\n"])));class X extends u.PureComponent{constructor(){super(...arguments),this.state={map:void 0},this.mapRef=u.createRef(),this.mapEl=null,this.attachClickHandler=()=>{const e=this.state.map;if(!e)return;const{api:t,onClick:n}=this.props,{event:o}=t;this.clickHandler&&this.clickHandler.remove(),n&&(this.clickHandler=o.addListener(e,"click",n))},this.setMapElement=e=>{if(e&&e!==this.mapEl){const t=this.constructMap(e);this.setState({map:t},this.attachClickHandler)}this.mapEl=e}}componentDidMount(){this.attachClickHandler()}componentDidUpdate(e){const t=this.state.map;if(!t)return;const{onClick:n,location:o,bounds:r}=this.props;e.onClick!==n&&this.attachClickHandler(),N(e.location,o)||t.panTo(this.getCenter()),!r||e.bounds&&r.equals(e.bounds)||t.fitBounds(r)}componentWillUnmount(){this.clickHandler&&this.clickHandler.remove()}getCenter(){const{location:e,api:t}=this.props;return new t.LatLng(e.lat,e.lng)}constructMap(e){const{defaultZoom:t,api:n,mapTypeControl:o,controlSize:r,bounds:i,scrollWheel:a}=this.props,l=new n.Map(e,{zoom:t,center:this.getCenter(),scrollwheel:a,streetViewControl:!1,mapTypeControl:o,controlSize:r});return i&&l.fitBounds(i),l}render(){const{children:e}=this.props,{map:t}=this.state;return c(d,{children:[p(J,{ref:this.setMapElement}),e&&t?e(t):null]})}}X.defaultProps={defaultZoom:8,scrollWheel:!0};class q extends h.PureComponent{constructor(){super(...arguments),this.eventHandlers={}}componentDidMount(){const{position:e,api:t,map:n,onMove:o,zIndex:r,opacity:i,label:a,markerRef:l,color:s}=this.props,{Marker:c}=t;let p;s&&(p={path:"M 3.052 3.7 C 1.56 5.293 0.626 7.612 0.663 9.793 C 0.738 14.352 2.793 16.077 6.078 22.351 C 7.263 25.111 8.497 28.032 9.672 32.871 C 9.835 33.584 9.994 34.246 10.069 34.305 C 10.143 34.362 10.301 33.697 10.465 32.983 C 11.639 28.145 12.875 25.226 14.059 22.466 C 17.344 16.192 19.398 14.466 19.474 9.908 C 19.511 7.727 18.574 5.405 17.083 3.814 C 15.379 1.994 12.809 0.649 10.069 0.593 C 7.328 0.536 4.756 1.882 3.052 3.7 Z",fillOpacity:1,fillColor:s.background,strokeColor:s.border,strokeWeight:2,anchor:new t.Point(10,35),labelOrigin:new t.Point(10,11)}),this.marker=new c({draggable:Boolean(o),position:e,map:n,zIndex:r,opacity:i,label:a,icon:p}),l&&(l.current=this.marker),this.attachMoveHandler(),this.attachClickHandler()}componentDidUpdate(e){if(!this.marker)return;const{position:t,onMove:n,label:o,zIndex:r,opacity:i,map:a}=this.props;e.onMove!==n&&this.attachMoveHandler(),N(e.position,t)||this.marker.setPosition(t),e.label!==o&&this.marker.setLabel(o||null),e.zIndex!==r&&this.marker.setZIndex(r||null),e.opacity!==i&&this.marker.setOpacity(i||null),e.map!==a&&this.marker.setMap(a)}componentWillUnmount(){this.eventHandlers.move&&this.eventHandlers.move.remove(),this.marker&&this.marker.setMap(null)}attachMoveHandler(){const{api:e,onMove:t}=this.props;this.eventHandlers.move&&this.eventHandlers.move.remove(),this.marker&&t&&(this.eventHandlers.move=e.event.addListener(this.marker,"dragend",t))}attachClickHandler(){const{api:e,onClick:t}=this.props;this.eventHandlers.click&&this.eventHandlers.click.remove(),this.marker&&t&&(this.eventHandlers.click=e.event.addListener(this.marker,"click",t))}render(){return null}}const Q={lat:40.7058254,lng:-74.1180863};class Y extends u.PureComponent{constructor(){super(...arguments),this.mapRef=u.createRef(),this.handlePlaceChanged=e=>{var t;(null==(t=e.geometry)?void 0:t.location)&&this.setValue(e.geometry.location)},this.handleMarkerDragEnd=e=>{e.latLng&&this.setValue(e.latLng)},this.handleMapClick=e=>{e.latLng&&this.setValue(e.latLng)}}getCenter(){const{value:e={},defaultLocation:t={}}=this.props;return a(a(a({},Q),t),e)}setValue(e){this.props.onChange&&this.props.onChange(e)}render(){const{api:e,defaultZoom:t,value:n,onChange:o}=this.props;return p(X,{api:e,location:this.getCenter(),onClick:this.handleMapClick,defaultZoom:t,children:t=>c(d,{children:[p(F,{api:e,map:t,onChange:this.handlePlaceChanged}),n&&p(q,{api:e,map:t,position:n,onMove:o?this.handleMarkerDragEnd:void 0})]})})}}Y.defaultProps={defaultZoom:8,defaultLocation:{lng:10.74609,lat:59.91273}};const $=S.img(n||(n=s(["\n  width: 100%;\n  height: auto;\n  vertical-align: top;\n"]))),ee=S.div(o||(o=s(["\n  height: 40rem;\n  width: 50rem;\n"])));let te;function ne(){return te}function oe(e){te=e}const re=(e,t)=>{const n="".concat(e.lat,",").concat(e.lng),o={key:t,center:n,markers:n,zoom:13,scale:2,size:"640x300"},r=Object.keys(o).reduce(((e,t)=>e.concat("".concat(t,"=").concat(encodeURIComponent(o[t])))),[]);return"https://maps.googleapis.com/maps/api/staticmap?".concat(r.join("&"))};class ie extends u.PureComponent{constructor(e){super(e),this._geopointInputId=g("GeopointInput"),this.setEditButton=e=>{this.editButton=e},this.handleToggleModal=()=>{this.setState((e=>({modalOpen:!e.modalOpen})))},this.handleCloseModal=()=>{this.setState({modalOpen:!1})},this.handleChange=e=>{const{schemaType:t,onChange:n}=this.props;n([I({_type:t.name}),H(e.lat(),["lat"]),H(e.lng(),["lng"])])},this.handleClear=()=>{const{onChange:e}=this.props;e(E())},this.state={modalOpen:!1}}focus(){this.editButton&&this.editButton.focus()}render(){const{value:e,readOnly:t,geoConfig:n,path:o,changed:r,focused:i}=this.props,{modalOpen:a}=this.state;return n&&n.apiKey?c(d,{children:[e&&p(R,{path:o,isChanged:r,hasFocus:!!i,children:p($,{src:re(e,n.apiKey),alt:"Map location"})}),!t&&p(y,{marginTop:4,children:c(w,{columns:2,gap:2,children:[p(M,{mode:"ghost",icon:e&&O,padding:3,ref:this.setEditButton,text:e?"Edit":"Set location",onClick:this.handleToggleModal}),e&&p(M,{tone:"critical",icon:x,padding:3,mode:"ghost",text:"Remove",onClick:this.handleClear})]})}),a&&p(P,{id:"".concat(this._geopointInputId,"_dialog"),onClose:this.handleCloseModal,header:"Place the marker on the map",width:1,children:p(ee,{children:p(Z,{config:ne(),children:o=>p(Y,{api:o,value:e||void 0,onChange:t?void 0:this.handleChange,defaultLocation:n.defaultLocation,defaultZoom:n.defaultZoom})})})})]}):c("div",{children:[c("p",{children:["The ",p("a",{href:"https://sanity.io/docs/schema-types/geopoint-type",children:"Geopoint type"})," needs a Google Maps API key with access to:"]}),c("ul",{children:[p("li",{children:"Google Maps JavaScript API"}),p("li",{children:"Google Places API Web Service"}),p("li",{children:"Google Static Maps API"})]}),p("p",{children:"Please enter the API key with access to these services in your googleMapsInput plugin config."})]})}}class ae extends h.PureComponent{constructor(){super(...arguments),this.eventHandlers={}}componentDidMount(){const{from:e,to:t,api:n,map:o,zIndex:r,onClick:i,color:a,arrowRef:l}=this.props,s={path:n.SymbolPath.FORWARD_OPEN_ARROW};this.line=new n.Polyline({map:o,zIndex:r,path:[e,t],icons:[{icon:s,offset:"50%"}],strokeOpacity:.55,strokeColor:a?a.text:"black"}),i&&(this.eventHandlers.click=n.event.addListener(this.line,"click",i)),l&&(l.current=this.line)}componentDidUpdate(e){if(!this.line)return;const{from:t,to:n,map:o}=this.props;N(e.from,t)&&N(e.to,n)||this.line.setPath([t,n]),e.map!==o&&this.line.setMap(o)}componentWillUnmount(){this.line&&this.line.setMap(null),this.eventHandlers.click&&this.eventHandlers.click.remove()}render(){return null}}function le(e){let{diff:t,api:n,map:o,label:r}=e;const{fromValue:i,toValue:a}=t,l=t.isChanged?t.annotation:void 0,s=L(l?l.author:null)||void 0,u=h.useRef(),m=h.useRef();return c(d,{children:[i&&p(q,{api:n,map:o,position:i,zIndex:0,opacity:.55,markerRef:u,color:s}),i&&a&&p(ae,{api:n,map:o,from:i,to:a,zIndex:1,color:s}),a&&p(q,{api:n,map:o,position:a,zIndex:2,markerRef:m,label:r,color:s})]})}const se=S.div(r||(r=s(["\n  position: relative;\n  min-height: 200px;\n\n  &:empty {\n    background-color: var(--card-skeleton-color-from);\n    display: table;\n    width: 100%;\n  }\n\n  &:empty:after {\n    content: 'Missing/invalid data';\n    display: table-cell;\n    vertical-align: middle;\n    text-align: center;\n    position: relative;\n  }\n"]))),ce=e=>{let{diff:t,schemaType:n}=e;return p(se,{children:p(Z,{config:ne(),children:e=>p(pe,{api:e,diff:t,schemaType:n})})})};function pe(e){let{api:t,diff:n}=e;const o=(n.fromValue||[]).filter(de),r=(n.toValue||[]).filter(de);if(0===o.length&&0===r.length)return null;const i=function(e,t,n){const o=new n.LatLngBounds;return[...e||[],...t||[]].forEach((e=>o.extend(e))),o}(o,r,t);return p(X,{api:t,location:i.getCenter().toJSON(),mapTypeControl:!1,controlSize:20,bounds:i,children:e=>p(d,{children:n.items.map((n=>{let{toIndex:o,diff:r}=n;return function(e){return"unchanged"!==e.action&&"object"===e.type}(r)?p(le,{api:t,map:e,diff:r,label:"".concat(o)},o):null}))})})}function de(e){return"number"==typeof e.lat&&"number"==typeof e.lng}const he=e=>{let{diff:t,schemaType:n}=e;return p(se,{children:p(Z,{config:ne(),children:e=>p(ue,{api:e,diff:t,schemaType:n})})})};function ue(e){let{api:t,diff:n}=e;const{fromValue:o,toValue:r}=n,i=j(n,["lat"])||j(n,["lng"])||j(n,[]),a=function(e,t){const{fromValue:n,toValue:o}=e;if(n&&o)return me(n,o,t).getCenter().toJSON();if(n)return n;if(o)return o;throw new Error("Neither a from or a to value present")}(n,t),l=o&&r?me(o,r,t):void 0;return p(z,{annotations:i?[i]:[],description:fe(n),children:p("div",{children:p(X,{api:t,location:a,mapTypeControl:!1,controlSize:20,bounds:l,scrollWheel:!1,children:e=>p(le,{api:t,map:e,diff:n})})})})}function me(e,t,n){return(new n.LatLngBounds).extend(e).extend(t)}function fe(e){const{fromValue:t,toValue:n}=e;return t&&n?"Moved":t?"Removed":n?"Added":"Unchanged"}const ge=T((e=>(oe(e),{name:"google-maps-input",form:{components:{input(t){if(ve("geopoint",t.schemaType)){return p(ie,a(a({},t),{},{geoConfig:e}))}return t.renderDefault(t)}}}})));function ve(e,t){return(null==t?void 0:t.name)===e||!!(null==t?void 0:t.name)&&ve(e,null==t?void 0:t.type)}export{ce as GeopointArrayDiff,he as GeopointFieldDiff,ie as GeopointInput,ge as googleMapsInput};
//# sourceMappingURL=index.esm.js.map
