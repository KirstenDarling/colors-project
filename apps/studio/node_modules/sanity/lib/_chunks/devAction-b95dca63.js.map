{"version":3,"file":"devAction-b95dca63.js","sources":["../../src/_internal/cli/server/devServer.ts","../../src/_internal/cli/actions/dev/devAction.ts"],"sourcesContent":["import chalk from 'chalk'\nimport {createServer} from 'vite'\nimport type {UserViteConfig} from '@sanity/cli'\nimport {extendViteConfigWithUserConfig, getViteConfig} from './getViteConfig'\nimport {debug} from './debug'\nimport {writeSanityRuntime} from './runtime'\n\nexport interface DevServerOptions {\n  cwd: string\n  basePath: string\n  staticPath: string\n\n  httpPort: number\n  httpHost?: string\n  projectName?: string\n\n  reactStrictMode: boolean\n  vite?: UserViteConfig\n}\n\nexport interface DevServer {\n  close(): Promise<void>\n}\n\nexport async function startDevServer(options: DevServerOptions): Promise<DevServer> {\n  const {cwd, httpPort, httpHost, basePath, reactStrictMode, vite: extendViteConfig} = options\n\n  const startTime = Date.now()\n  debug('Writing Sanity runtime files')\n  await writeSanityRuntime({cwd, reactStrictMode, watch: true, basePath})\n\n  debug('Resolving vite config')\n  const mode = 'development'\n  let viteConfig = await getViteConfig({\n    basePath,\n    mode: 'development',\n    server: {port: httpPort, host: httpHost},\n    cwd,\n  })\n\n  // Extend Vite configuration with user-provided config\n  if (extendViteConfig) {\n    viteConfig = await extendViteConfigWithUserConfig(\n      {command: 'serve', mode},\n      viteConfig,\n      extendViteConfig\n    )\n  }\n\n  debug('Creating vite server')\n  const server = await createServer(viteConfig)\n  const info = server.config.logger.info\n\n  debug('Listening on specified port')\n  await server.listen()\n\n  const startupDuration = Date.now() - startTime\n  const url = `http://${httpHost || 'localhost'}:${httpPort || '3333'}${basePath}`\n  info(\n    `Sanity Studio ` +\n      `using ${chalk.cyan(`vite@${require('vite/package.json').version}`)} ` +\n      `ready in ${chalk.cyan(`${Math.ceil(startupDuration)}ms`)} ` +\n      `and running at ${chalk.cyan(url)}`\n  )\n\n  return {close: () => server.close()}\n}\n","import path from 'path'\nimport type {CliConfig, CliCommandArguments, CliCommandContext, CliOutputter} from '@sanity/cli'\nimport {DevServerOptions, startDevServer} from '../../server/devServer'\nimport {getTimer} from '../../util/timing'\nimport {checkStudioDependencyVersions} from '../../util/checkStudioDependencyVersions'\nimport {checkRequiredDependencies} from '../../util/checkRequiredDependencies'\nimport {getSharedServerConfig, gracefulServerDeath} from '../../util/servers'\n\nexport interface StartDevServerCommandFlags {\n  host?: string\n  port?: string\n}\n\nexport default async function startSanityDevServer(\n  args: CliCommandArguments<StartDevServerCommandFlags>,\n  context: CliCommandContext\n): Promise<void> {\n  const timers = getTimer()\n  const flags = args.extOptions\n  const {output, workDir, cliConfig} = context\n\n  timers.start('checkStudioDependencyVersions')\n  checkStudioDependencyVersions(workDir)\n  timers.end('checkStudioDependencyVersions')\n\n  // If the check resulted in a dependency install, the CLI command will be re-run,\n  // thus we want to exit early\n  if ((await checkRequiredDependencies(context)).didInstall) {\n    return\n  }\n\n  // Try to load CLI configuration from sanity.cli.(js|ts)\n  const config = getDevServerConfig({flags, workDir, cliConfig, output})\n\n  try {\n    await startDevServer(config)\n  } catch (err) {\n    gracefulServerDeath('dev', config.httpHost, config.httpPort, err)\n  }\n}\n\nfunction getDevServerConfig({\n  flags,\n  workDir,\n  cliConfig,\n  output,\n}: {\n  flags: StartDevServerCommandFlags\n  workDir: string\n  cliConfig?: CliConfig\n  output: CliOutputter\n}): DevServerOptions {\n  const configSpinner = output.spinner('Checking configuration files...')\n  const baseConfig = getSharedServerConfig({flags, workDir, cliConfig})\n  configSpinner.succeed()\n\n  const env = process.env // eslint-disable-line no-process-env\n  const reactStrictMode = env.SANITY_STUDIO_REACT_STRICT_MODE\n    ? env.SANITY_STUDIO_REACT_STRICT_MODE === 'true'\n    : Boolean(cliConfig?.reactStrictMode)\n\n  if (env.SANITY_STUDIO_BASEPATH && cliConfig?.project?.basePath) {\n    output.warn(\n      `Overriding configured base path (${cliConfig.project.basePath}) with value from environment variable (${env.SANITY_STUDIO_BASEPATH})`\n    )\n  }\n\n  return {\n    ...baseConfig,\n    staticPath: path.join(workDir, 'static'),\n    reactStrictMode,\n  }\n}\n"],"names":["startDevServer","options","cwd","httpPort","httpHost","basePath","reactStrictMode","vite","extendViteConfig","startTime","Date","now","debug","writeSanityRuntime","watch","mode","viteConfig","getViteConfig","server","port","host","extendViteConfigWithUserConfig","command","createServer","info","config","logger","listen","startupDuration","url","concat","chalk","cyan","require","version","Math","ceil","close","startSanityDevServer","args","context","timers","getTimer","flags","extOptions","output","workDir","cliConfig","start","checkStudioDependencyVersions","end","checkRequiredDependencies","didInstall","getDevServerConfig","err","gracefulServerDeath","_ref","_a","configSpinner","spinner","baseConfig","getSharedServerConfig","succeed","env","process","SANITY_STUDIO_REACT_STRICT_MODE","Boolean","SANITY_STUDIO_BASEPATH","project","warn","staticPath","path","join"],"mappings":"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"}